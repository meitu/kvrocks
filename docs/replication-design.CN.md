
# 介绍

## 复制rocksdb数据
当接收到 SLAVEOF 命令时，一个实例被转换为从角色（Slave），Slave 将尝试进行部分同步(也叫增量复制)。如果无法进行部分同步，Slave 将进行全量同步。

Slave 拉取 Master 侧 Rocksdb 的最新快照文件(2.0.0版本之前，Kvrocks使用备份文件)，使用从主服务器下载的快照文件进行恢复，并且从服务器的数据库将被删除，然后再次触发部分同步。如果一切正常，部分同步是一个持续的过程，它不断接收 Master 最新执行的写命令相关的数据。

## 复制过程

状态机存在于从服务器的复制线程中，在从端，复制由以下步骤组成:

1. 发送身份验证
2. 发送 db_name 来检查主服务器是否有正确的数据库
3. 尝试进行增量同步，如果成功，Slave 循环接收增量数据; 否则， 执行步骤 4
4. 全量同步 
5. 重新开始步骤 1

## 增量同步(PSYNC)

PSYNC 是在主角色实例上执行的异步命令，当 PSYNC 命令被 Master 服务器接收，Master 会将命令接收成功返回给客户端，此时，实际的同步工作才正式开始。

PSYNC 利用了 Rocksdb 的 WAL 判断是否可以进行增量同步，如果 PSYNC 的请求的序列号在 WAL 文件的序号范围内，则认为可以进行 PSYNC。

如果可以进行增量同步，Master 侧会循环检查 WAL，当 WAL 中有数据的时候，将会向 Slave 发送增量数据，如果 WAL 中没有增量数据，将等待 2 秒，并同时朝 Slave 发送 Ping 命令进行探活。

## 全量同步(FULLSYNC)

为了支持全量同步，Master 在每次接收到来自 Slave 的 _fetch_meta 命令时会生成一个 Rocksdb 快照，然后将快照的文件列表回复给 Slave。

Slave 成功获取元数据（快照文件列表）之后，会根据快照文件列表中的文件名发送 _fetch_file 命令给 Master 拉取对应的文件，用这些文件恢复 RocksDB 数据库，Kvrocks 会通过并行处理，加速文件的拉取。