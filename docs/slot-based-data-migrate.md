# 一、数据迁移简介

  数据迁移功能是分布式数据库系统的重要功能，是数据库实现扩、缩容的基础。数据迁移的主要方案有：基于key的数据迁移、基于slot的数据迁移、独立的迁移组件迁移数据等；基于key的数据迁移方案效率较低且失败回滚难，采用独立的迁移工具则迁移过程中各组件的状态维护难，故，kvrocks采用基于slot的迁移方案。 kvrocks基于slot的迁移方案确保某一slot的数据迁移要么全部成功、要么全部失败回滚，在保证数据安全性的同时，也充分考虑迁移效率。

# 二、基于slot的数据迁移方案

## 2.1 数据编码

  有效且高效的区分不同slot的key，是基于slot迁移数据方案的基础。kvrocks的数据编码将key对应的slot同key一起编码存储，如图2.1 所示。图中key即为用户存储的key，如图可知，所有key都有固定prefix：|Ns_len|Ns|Slot_id|，其中Slot_id即为key所对应的slot号。kvrocks底层存储引擎为rocksdb，这样的编码方式可以有效的利用rocksdb的迭代器，使用slot号构造该slot的key的prefix即可有效的区分，并高效的迭代出DB中属于该slot的所有key。

![PegaDB2.0______](/Users/zoumingfo/Downloads/PegaDB2.0______.png)

 <center>图 2.1 kvrocks数据编码格式</center>

## 2.2 基于slot迁移主要思想

  基于slot迁移的主要思想是将数据的迁移分为两个主要阶段：存量数据迁移阶段、增量数据迁移阶段。

**存量数据迁移阶段：**存量数据指发起数据迁移时刻，DB中已经存在的数据。在存量数据迁移阶段，DB保持可读可写，不影响DB的可用性；

**增量数据迁移阶段：**增量数据是由于存量数据发送阶段不对DB禁写，故可能产生新增的数据，这部分数据即为增量数据。为了保持DB的高可用性，增量数据的迁移阶段又分为两步进行。

- 第一步，发送存量数据迁移过程中产生的增量数据，此时DB仍保持可读可写，故在此期间可能又会产生新增数据。
- 第二步，增量数据迁移阶段产生的新增数据。为了数据的一致性，在第二步需要禁写DB中正在迁移的slot。
- 由于第二步执行过程需要禁写slot，而第一步执行过程中可能新增了大量的数据，这可能导致第二步执行时间很长，进而导致slot禁写时间过长。为避免对DB可用性带来影响，将第一步设计为执行多次，即在发现有大量新增数据时仍不禁写迁移，直到新增数据收敛到一定小的阈值，再开启第二步禁写迁移步骤。

**数据迁移方式：**

  无论增量或存量数据的迁移都采用构造写命令方式，如string数类型则构造“set key value”格式的写命令，发送给目的端；目的端接收并执行命令，完成数据写入，并回复数据发送端执行结果，保证数据成功写入新DB。存量数据采用rocksdb的snapshot机制获取DB的存量数据，增量数据则通过解析rocksdb的WAL文件获取新增的数据。

## 2.3 基于slot迁移详细流程

  kvrocks基于slot的迁移方案采用主动迁移的方式，即由源端主动迁移指定slot的数据到目的端，目的端被动导入数据。

  基于slot数据迁移详细步骤如图2.2所示。为便于叙述整体流程，先进行如下概念定义：

- 目标slot：将要迁移的slot
- SRC：对应图中的Source Server，为目标slot当前所在的server，数据将从该server迁出
- DST：对应图中的Destination Server，为目标slot迁移的目的地server，数据将导入该server
- Migration Thread：对应图中Slot migration Thread，是一个守护线程，由此守护线程完成具体的数据迁移步骤

### 2.3.1 迁移流程

  图2.2中“MIGRATION_"开头的字段表示数据迁移的不同状态，分别代表了数据迁移的不同阶段，在各阶段Migration Thread完成该阶段对应的任务。数据迁移整体流程可以分为如下步骤：

1. SRC接收到数据迁移请求，准备开启数据迁移；
2. MIGRATION_START阶段SRC准备好存量数据snapshot，并通知DST准备好接收数据；
3. MIGRATION_SNAPSHOT阶段即为存量数据发送阶段，SRC发送目标slot的存量数据；通过构造写命令发送给DST，DST接收到写命令执行命令即可；
4. MIGRATION_WAL阶段即为增量数据发送阶段，由2.2节可知，此阶段分两步进行，分别在不禁写、禁写目标slot的情况下进行增量数据的迁移；
5. MIGRATION_SUCCESS阶段即数据迁移成功完成，此时需要通知DST端数据已发送完成，待DST端确认接收完成后，清除SRC端的目标slot的数据；
6. 目标slot的数据迁移完成后，集群的topo结构将进行修改，目标slot新的数据将写到DST端。

![PegaDB2.0______ (1)](/Users/zoumingfo/Downloads/PegaDB2.0______ (1).png)

<center>图2.2 kvrocks数据迁移流程</center>

### 2.3.2 迁移状态

上文提及的数据迁移过程中的不同状态随迁移任务进行到不同阶段而进行转换，以上的状态并不完整，详细的状态如表2.1所示：

<center>表2.1 数据迁移过程状态表</center>

| 序号 | 状态名称           | 含义                                                         |
| :--- | :----------------- | :----------------------------------------------------------- |
| 1    | MIGRATION_NONE     | 代表当前没有slot在进行迁移，默认状态                         |
| 2    | MIGRATION_START    | 代表SRC接收到迁移指令，并准备迁移目标slot的数据阶段          |
| 3    | MIGRATION_SNAPSHOT | 代表SRC迁移目标slot的存量数据的阶段，通过解析snapshot获取存量数据 |
| 4    | MIGRATION_WAL      | 代表SRC迁移目标slot的增量数据的阶段，通过解析wal获取增量数据 |
| 5    | MIGRATION_SUCCESS  | 代表SRC成功完成目标slot的数据迁移，将通知DST端迁移成功，并清除SRC端该slot的数据 |
| 6    | MIGRATION_FAIL     | 代表SRC处理迁移目标slot数据失败阶段，将通知DST端迁移失败，并停止迁移 |
| 7    | MIGRATION_CLEAN    | 无论SRC迁移目标slot数据成功或失败，都需要释放迁移过程中的锁定的一些资源，如释放snapshot |

上述各状态转换关系如图2.3所示：

![PegaDB2.0__________](/Users/zoumingfo/Downloads/PegaDB2.0__________.png)

<center>图2.3 kvrocks数据迁移状态转换关系</center>

# 三、说明

1、同一时刻只有一个slot处于迁移状态；

2、在数据迁移过程中，为提升迁移效率，命令的发送将采用pipeline的方式，即每次不止发送条命令，而是多条命令汇总一次发送；

3、迁移过程的状态可以通过命令询问源端server获取。